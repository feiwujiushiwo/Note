# Docker入门指南（下）

## 第六部分：持久化数据

有没有发现，每次启动容器时，我们的待办事项列表都是空的。为什么是这样？在这一部分中，我们将深入了解容器的工作原理。

### 1、容器的文件系统

当容器运行时，它会使用镜像中的各个层作为其文件系统。同时每个容器还拥有自己的“临时空间”来创建/更新/删除文件。即使它们使用相同的镜像，任何更改都不会在另一个容器中看到。

接下来我们做一个小的实验：

实验内容：使用相同的镜像启动两个容器，在其中一个容器中添加一个文件，然后我们在另一个容器中去尝试访问那个文件。

准备：拉取一个centos7镜像

```
docker pull centos:7
```

**启动第一个容器：**

```
docker run -d centos:7 /bin/bash -c "while true;do sleep 1; done"
```

1. 查看容器运行状态

```
docker ps
```

2. 应该可以看到我们的容器已经成功启动，现在进入我们的第一个容器

```
docker exec -it <id> /bin/bash
```

> Note：
>
> exec是进入容器的命令，-it（-i -t）告诉docker我们要以交互模式进入容器，也就是创造一个伪终端让我们能与容器进行交互。
>
> 进入容器时要加/bin/bash，是因为在Docker中，必须要保持一个进程的运行，否则容器启动后会马上被kill掉。/bin/bash表示启动容器后启动bash，对指定的容器执行bash。
>
> Bash是一个命令处理器，通常运行于文本窗口中，并能执行用户直接输入的命令。
>
> Tips：
>
> id可以只输入前三位，如果失败了就复制完整id。

3. 现在你应该已经在我们的容器里面了，让我们创建一个文件吧！

```bash
echo "12345" > test.txt #这个命令会在当前目录创建一个test.txt文件并写入12345
```

4. 查看我们当前目录，你会看到一个test.txt文件

```bash
ls
```

5. 好了，我们可以退出这个容器了，输入exit并回车   or    按ctrl+D

**现在我们启动第二个容器（使用相同的镜像）：**

```bash
docker run -d centos:7 /bin/bash -c "while true;do sleep 1; done"
```

1. 参考刚才的操作进入第二个容器（上面没太懂的接着往下看）

> 第一步，查看我们第二个容器的id
>
> ```bash
> docker ps
> ```
>
> 第二步，进入容器
>
> ```bash
> docker exec -it <id> /bin/bash
> ```
>
> 现在我们看一下我们当前目录，你会发现并没有我们刚才创建的test.txt文件
>
> ```bash
> ls
> ```
>
> 退出容器

​	到这里我们的实验已经完成，实验中我们在第一个容器创建的test.txt文件并不能在第二个容器中看到，这是因为它仅写入第一个容器的“临时空间”。现在我们可以删除刚才的那两个容器了，使用docker stop和rm命令

```bash
docker stop <id1> <id2>
docker rm  -f <id1> <id2>
```

相信通过这个实验，我们应该知道了为什么每次启动容器时，我们的待办事项列表都是空的。那我们应该怎么解决这个问题呢？

### 2、容器的卷（volumes）

在前面的实验中，你看到每个容器每次启动时都从映像定义开始。 虽然容器可以创建、更新和删除文件，但在删除容器时，这些更改将丢失 Docker 会隔离对该容器的所有更改。使用卷，您可以更改所有这些。 

[卷 ](https://docs.docker.com/storage/volumes/)提供了连接特定文件系统路径的能力 将容器返回到主机。如果在容器中挂载目录，则该目录会发生变化 目录也可以在主机上看到。如果在容器重启时装载同一目录，则会看到 相同的文件。 

卷主要有两种类型。您最终将同时使用两者，但您将从卷装载开始。 

### 3、保留数据

默认情况下，todo 应用将其数据存储在 SQLite 数据库中，位于 `/etc/todos/todo.db` 在容器的文件系统中。如果您不熟悉SQLite，请不要担心！它只是一个关系数据库，将所有数据存储在一个文件中。虽然这不是大规模应用程序的最佳选择， 它适用于小型演示。稍后将了解如何将其切换到其他数据库引擎。 

如果数据库是单个文件，如果可以将该文件保留在主机上并使其可供 下一个容器，它应该能够从最后一个容器停止的地方继续。通过创建卷并附加 （通常称为“挂载”）将其保存到存储数据的目录中，可以持久保存数据。作为您的容器 写入  `todo.db` 文件，它会将数据保存到卷中的主机。 

如前所述，您将使用卷装载。将卷装载视为不透明的数据桶。 Docker 完全管理卷，包括磁盘上的存储位置。你只需要记住 卷的名称。 

#### 3.1、创建卷并启动容器

1. 使用  `docker volume create` 命令。 

```bash
docker volume create todo-db
```

2. 停止并再次删除待办事项应用容器  `docker rm -f <id>`，因为它仍在运行而不使用持久卷。 

3. 启动 todo 应用容器，但添加  `--mount` 选项来指定卷装载。为卷命名，然后挂载 它到  `/etc/todos` 在容器中，捕获在路径中创建的所有文件。在 Mac 或 Linux 终端中，或者在 Windows 命令提示符或 PowerShell 中，运行以下命令： 

```bash
docker run -dp 127.0.0.1:3000:3000 --mount type=volume,src=todo-db,target=/etc/todos getting-started
```

#### 3.2、验证数据持久化

1. 容器启动后，打开应用并将一些项目添加到待办事项列表中。 

   ![添加到待办事项列表的项目](https://docs.docker.com/get-started/images/items-added.webp)

2. 停止并删除待办事项应用的容器。 使用 Docker Desktop 或  `docker ps` 获取 ID，然后  `docker rm -f <id>` 将其删除。 

3. 使用前面的步骤启动新容器。 

4. 打开应用程序。您应该看到您的项目仍在列表中。 

5. 签完列表后，继续删除容器。 

### 4、深入了解volumes

很多人经常问“当我使用卷时，Docker 将我的数据存储在哪里？ 如果你想知道， 您可以使用  `docker volume inspect` 命令。 

```console
$ docker volume inspect todo-db
[
    {
        "CreatedAt": "2019-09-26T02:18:36Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/todo-db/_data",
        "Name": "todo-db",
        "Options": {},
        "Scope": "local"
    }
]
```

这  `Mountpoint` 是数据在磁盘上的实际位置。请注意，在大多数计算机上，您将 需要具有 root 访问权限才能从主机访问此目录。 

## 第七部分：使用绑定挂载

绑定挂载是另一种类型的挂载，它允许您将主机文件系统中的目录共享到容器中。在处理应用程序时，您可以使用绑定挂载将源代码挂载到容器中。

一旦您保存文件，容器就会立即看到您对代码所做的更改。这意味着您可以在容器中运行进程来监视文件系统更改并对其做出响应。

在本章中，您将了解如何使用绑定挂载和名为 nodemonopen_in_new 的工具来监视文件更改，然后自动重新启动应用程序。大多数其他语言和框架都有等效的工具。

### 1、





## 第八部分：多容器应用程序

> 将容器分开运行有几个重要的原因：
>
> 1. **隔离性和安全性：** 每个容器在其自己的运行环境中执行，容器之间相互隔离。这种隔离性可防止容器之间的相互干扰，降低了安全风险，即使其中一个容器受到攻击，其他容器也能保持相对安全。
> 2. **可维护性和可扩展性：** 将不同的服务或应用程序放置在不同的容器中，使得系统更容易维护和扩展。当需要更新或更改某个服务时，只需针对该服务的容器进行修改，而不会影响其他容器和服务。
> 3. **资源隔离和优化：** 容器能够独立管理资源，如内存、CPU 和存储空间。通过分开运行，您可以为每个容器分配特定的资源，防止其中一个容器消耗过多的资源影响其他容器的性能。
> 4. **轻量级和灵活性：** 容器是轻量级的，可以快速启动和停止，提供了更大的灵活性和便利性。这使得开发人员能够快速部署新的应用或服务，更容易地进行测试和开发。
>
> 总的来说，容器的分开运行有助于提高安全性、维护性和灵活性，使得整体系统更稳定、更易于管理和扩展。

这部分我们要给我们的Web应用程序（Todo App）添加一个数据库

多个容器中运行应用。 

![Todo App 连接到 MySQL 容器](https://docs.docker.com/get-started/images/multi-container.webp?w=350h=250)

### 1、容器网络

默认情况下，容器是孤立运行的，与其他容器是互不干涉的。那么，如何允许一个容器与另一个容器通信呢？

> 答案：联网。如果将两个容器放在同一个网络上，它们可以相互通信。

## 第九部分：使用docker-compose



## 第十部分：镜像构建最佳实践



## 第十一部分：结语