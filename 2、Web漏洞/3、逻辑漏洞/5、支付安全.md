# 支付安全

## 1、概述

### 1.1、常见漏洞

**支付场景的安全性**关系到用户资金和数据安全，因此在支付功能的设计和实施中，必须特别注意下面的漏洞，并采取相应的安全措施来防范风险。

| 漏洞类型     | 描述                                               |
| ------------ | -------------------------------------------------- |
| 溢出         | 输入金额超出预期范围，可能导致错误支付或数据损坏。 |
| 精度问题     | 不当的金额计算或处理可能导致支付金额错误。         |
| 负数问题     | 输入负数金额可能导致异常操作或欺诈。               |
| 修改参数     | 攻击者通过篡改参数（如金额）来进行欺诈性支付。     |
| 支付接口问题 | 接口设计不当可能导致支付功能出现安全隐患。         |

### 1.2、特殊问题

> 这两个单独放到后面的笔记

1. **特别竞争问题**

- **描述：** 在多线程或并发环境中，由于资源竞争而导致的支付操作异常或重复支付。
- **风险：** 可能导致资金重复扣款或支付异常。

2. **重放攻击问题**

- **描述：** 攻击者记录并重新发送先前的有效支付请求，重复执行某个交易。
- **风险：** 可能导致重复支付，损失资金或数据安全。

## 2、漏洞讲解

### 2.1、溢出

#### 溢出： 

整型变量拥有最大值/最小值，如果超出/低于这个值，就会造成整型变量溢出。

#### 常见整型变量的范围： 

- 有符号整型：

| 编程语言   | 最大值                                             | 最小值                                |
| ---------- | -------------------------------------------------- | ------------------------------------- |
| Java       | `Integer.MAX_VALUE`（2,147,483,647）               | `Integer.MIN_VALUE`（-2,147,483,648） |
| Python     | `sys.maxsize`（2的系统位数次方）                   | `-sys.maxsize - 1`                    |
| C/C++      | `INT_MAX`（2,147,483,647）                         | `INT_MIN`（-2,147,483,648）           |
| JavaScript | `Number.MAX_SAFE_INTEGER`（9,007,199,254,740,991） | `-Number.MAX_SAFE_INTEGER`            |

- 无符号整型：

| 编程语言 | 最大值                      | 最小值 |
| -------- | --------------------------- | ------ |
| Python   | -                           | `0`    |
| C/C++    | `UINT_MAX`（4,294,967,295） | `0`    |

>  除了整型数据以外，浮点数、double等类型也会出现溢出问题。

```c++
#include<iostream>
using namespace std;
int main()
{
for(int i=1;i>0;i++)
{
cout<<i<<endl;
}
cout<<"exit";
exit(0);
}
```

```
#这段代码会产生溢出，所有会打印出exit
```

#### 危害：

当变量发生溢出时，往往不能按照预先的逻辑继续执行，这时就可能会存在漏洞，例如：

- 购买商品时，想办法造成价格溢出，从而花较少的金额购买到大量商品。
- 也可以想办法造成余额下溢，这种情况往往在使用余额成功购买到超过用户当前余额的商品时会出现。

### 2.2、精度问题

可以尝试购买1.5个商品，系统如果有这方面的漏洞，将会以1.5个商品的价格售卖2个商品

> Tips：
>
> 通过抓包来修改商品个数。

### 2.3、负数问题

#### 负数问题： 

用户输入的数量、金额等可能会存在负数，此时应当对业务逻辑进行严格判断，避免负数影响业务正常逻辑，进而造成漏洞。

#### 攻击：

- 购物车中的商品正负相抵，支付时支付较少金额即可付款成功，而负数商品在商家界面不做显示。
- 负数商品购买造成余额增多或积分增加。

### 2.4、修改参数

#### 修改参数：

支付环节中涉及许多参数，当系统逻辑校验不严格时，可通过修改某些参数值来引起不当得利。

>  金额、优惠券、数量、积分、运费、币种、余额、付款账号、分期付款期次、支付奖励金等

| 参数         | 描述                           | 潜在攻击方式                           |
| ------------ | ------------------------------ | -------------------------------------- |
| 金额         | 支付的货币金额                 | 金额篡改，如溢出、负数支付、价格修改等 |
| 优惠券       | 可用于抵扣金额的优惠券码       | 伪造、重复使用或无效优惠券             |
| 数量         | 购买商品或服务的数量           | 修改数量，如购买数量为0或负数          |
| 积分         | 可用于抵扣金额或获取奖励的积分 | 虚假积分、重复使用积分、篡改积分值     |
| 运费         | 运送商品所需的费用             | 虚假运费、篡改运费价格                 |
| 币种         | 支付所使用的货币类型           | 修改币种，利用汇率变化获取利益         |
| 余额         | 用户支付账户余额               | 余额篡改、负余额支付                   |
| 付款账号     | 用于支付的账户信息             | 篡改收款账户、重复支付、虚假账户信息   |
| 分期付款期次 | 分期支付的期次                 | 修改期次、虚假分期信息                 |
| 支付奖励金   | 可用于支付或获取奖励的特殊资金 | 篡改奖励金金额、重复使用奖励金         |

#### 攻击：

- 直接修改价格参数，0元购车，1分钱充值100元话费。
- 修改币种，将货币类型改为日元，在金额不变的情况下使支付实际金额减少。
- 将运费修改为负数。
- 修改分期付款期次，改为无限大。

### 2.5、支付接口问题

#### 支付接口问题：

支付时，网站一般回调用**第三方支付接口**进行支付，当付款成功以后，第三方支付接口一般会回传支付成功的信息。在这个过程中如果缺乏合理校验，就有可能出现问题。

#### 攻击：

- 自定义支付接口
- 替换返回状态
- 支付订单仿冒
- 修改支付金额
- 修改收款人信息
