# 条件竞争漏洞

## 1、概述

### 1.1、条件竞争

当同一资源拥有多个申请占有者时会出现竞争性问题。

思考下面的情况是否有条件竞争：

- 电商平台买卖商品时，设计代码逻辑：在购买前判断商品剩余数量是否大于0，若是则继续售出商品。
- 用户使用积分兑换商品时，在兑换前判断用户积分余额是否大于本次所要消耗的积分，若是则允许兑换。

上述两种情况会出现条件竞争：

- 攻击者可以在判断商品数量后并发地购买同一商品，这可能导致实际上库存数量已经不足，但由于并发操作，系统仍然允许多次购买，导致超卖或负库存等问题。
- 攻击者可以同时发起多个兑换请求，并在系统判断前使用或消耗掉部分积分。即使单个请求判断通过，但多个请求并发执行可能导致实际积分已不足，却依然成功兑换商品，造成积分透支或超额消耗等问题。

### 1.2、危害

通过条件竞争漏洞实现“一券（优惠券）多用”。

## 2、漏洞防御

在数据库中添加事务锁。在考虑线程、进程并发时如果有需要，应当添加线程锁和进程锁。

| 防御措施       | 描述                                                         |
| -------------- | :----------------------------------------------------------- |
| 锁机制         | 使用锁来确保在某个操作进行时，其他操作不能同时进行，避免并发冲突。常见的锁包括悲观锁和乐观锁。 |
| 事务处理       | 在数据库操作中使用事务，确保一系列操作要么全部执行，要么全部回滚，防止部分操作执行导致的问题。 |
| 原子操作       | 在并发操作中保证操作的原子性，要么全部成功执行，要么全部不执行，通过原子操作保证数据的一致性。 |
| 合适的超时设置 | 设置适当的操作超时时间，避免长时间等待导致的资源浪费，及时释放锁或资源。 |
| 合理的并发控制 | 对关键操作进行合理的并发控制，避免并发竞争条件下的资源竞争。如限制并发请求、队列等。 |
